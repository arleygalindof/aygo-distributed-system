version: '3.8'

services:
  # üß© MongoDB
  mongo:
    image: mongo:3.6.1
    container_name: aygo-mongo
    ports:
      - "27018:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - aygo-network

  # üñ•Ô∏è Backend 1
  aygo-backend1:
    build:
      context: ./DistributedApp
      dockerfile: Dockerfile
    container_name: aygo-backend1
    ports:
      - "8081:8080"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo:27017/aygo
    depends_on:
      - mongo
    networks:
      - aygo-network

  # üñ•Ô∏è Backend 2
  aygo-backend2:
    build:
      context: ./DistributedApp
      dockerfile: Dockerfile
    container_name: aygo-backend2
    ports:
      - "8082:8080"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo:27017/aygo
    depends_on:
      - mongo
    networks:
      - aygo-network

  # üñ•Ô∏è Backend 3
  aygo-backend3:
    build:
      context: ./DistributedApp
      dockerfile: Dockerfile
    container_name: aygo-backend3
    ports:
      - "8083:8080"
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongo:27017/aygo
    depends_on:
      - mongo
    networks:
      - aygo-network

  # üåê Load Balancer (Nginx)
  loadbalancer:
    image: nginx:latest
    container_name: aygo-loadbalancer
    ports:
      - "8087:80"
    volumes:
      # Archivo de configuraci√≥n Nginx corregido
      - ./LoadBalancer/nginx.conf:/etc/nginx/nginx.conf:ro
      # Archivos est√°ticos del frontend
      - ./LoadBalancer/src/main/resources/static:/usr/share/nginx/html:ro
    depends_on:
      - aygo-backend1
      - aygo-backend2
      - aygo-backend3
    networks:
      - aygo-network

# üß† Red compartida
networks:
  aygo-network:
    driver: bridge

# üíæ Volumen persistente para Mongo
volumes:
  mongo-data:
